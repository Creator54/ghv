#!/usr/bin/env bash
# A CLI tool to explore public repositories hosted on GitHub.

# Check if required dependencies (jq, gh, fzf) are available
deps_status=$(which jq gh fzf)
if [[ ! $deps_status ]]; then
	echo "Please make sure jq, gh, and fzf are available in the environment!"
	exit 1
fi

# Function to display file content
function preview() {
	# Retrieve and display file content using gh and jq
	local file_content=$(gh api -X GET "/repos/$owner/$repo/contents/$path" | jq -r '.content' | base64 -d)
	echo "$file_content"
}

# Function to explore GitHub
function explorer() {
	selection=$(gh api -X GET "/repos/$owner/$repo/contents/$path" | jq -r '.[].name' | fzf --preview-window up:50% --header "$path") # Selection to check if it is a file or directory
	response=$(gh api -X GET "/repos/$owner/$repo/contents/$path")
	type_check=$(echo "$response" | jq -r 'type') # If object then preview, if array then open
	path="$path/$selection"

	if [[ $type_check == "object" ]]; then
		preview
	else
		explorer
	fi
}

# Read the URL as a command-line argument
url="$1"

# Check if the URL is provided
if [[ -z $url ]]; then
	echo "Please provide a GitHub URL or raw.githubusercontent URL as an argument."
	exit 1
else
	owner=$(echo $url | cut -d '/' -f1)
	repo=$(echo $url | cut -d '/' -f2)
	path=$(echo $url | cut -d '/' -f3)

	if [[ $owner -eq $repo ]]; then
		path=""
		repo=$(gh api "/users/$owner/repos?per_page=100&page=1" | jq -r '.[].name' | fzf --preview-window up:50% --header "$path")
		explorer
	fi
fi
